---
layout: post
title: åœ¨Androidå¹³å°ä¸‹åˆæˆGif
categories: 
	- Android
tags: 
  - Android
  - AndroidTips
keywords: 
	- Android
	- GIFåˆæˆ
abbrlink: 3121499733
date: 2016-03-09 00:00:00
---


æœ¬æ–‡ä»‹ç»åœ¨ `Android` å¹³å°ä¸‹åˆæˆ `GIF` çš„æ–¹æ³•ï¼ŒæŸ¥é˜…èµ„æ–™çš„è¿‡ç¨‹ä¸­å‘ç°å¤§è‡´æœ‰ä¸¤ç§æ–¹æ¡ˆã€‚

> 1. ä½¿ç”¨ `giflen` (ä¸€ä¸ª `C` çš„åˆæˆ `gif` çš„åº“) è¿›è¡Œ `gif` åˆæˆã€‚

> 2. ä½¿ç”¨ `java` å±‚çš„ `GifEncoder`ã€`LZWEncoder`ã€`NeuQuant` æ¥è¿›è¡Œ `gif` åˆæˆã€‚

å½“ç„¶äºŒè€…éƒ½æ˜¯åŸºäº `LZW` ç®—æ³•ï¼Œç®€å•æµ‹è¯•çš„ç»“æœæ˜¯ï¼Œé€Ÿåº¦ä¸Šå·®ä¸å¤šï¼Œç”±äºå¯¹ `C` ä¸æ˜¯å¾ˆæ“…é•¿ï¼Œå› æ­¤æˆ‘é€‰æ‹©äº† `java` å±‚è¿›è¡Œåˆæˆçš„æ–¹æ³•ï¼Œä½†æ˜¯ä¸¤ç§æ–¹æ³•é€Ÿåº¦ä¸Šéƒ½æ˜¯ **å¾ˆæ…¢å¾ˆæ…¢** ğŸ˜­ã€‚

å› æ­¤æœ¬æ–‡è¿˜å°†ä¼šä½¿ç”¨å¤šçº¿ç¨‹ç‹¬ç«‹ç¼–ç çš„æ–¹æ³•æ¥è¿›è¡Œä¼˜åŒ–ï¼Œæ¯å¸§å›¾ç‰‡å¹¶è¡Œç¼–ç ï¼ŒåŠ å¿«åˆæˆé€Ÿåº¦ï¼Œç°åœ¨çš„æˆæœæ˜¯ `600 * 450` çš„å›¾ç‰‡ `20` å¼ çš„è¯ï¼Œæ—¶é—´å¤§çº¦åœ¨ `12s` å·¦å³ã€‚


> **æœ¬æ–‡ç›¸å…³æºç åœ¨ [GitHub - GifMaker](https://github.com/chendongMarch/GifMaker)**


##  ä½¿ç”¨ giflen åˆæˆ

ä½¿ç”¨ `jni` åˆæˆï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ `google` ä¸€ä¸‹ `giflen` è¿™ä¸ªåº“ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç¼–è¯‘å¥½çš„ `so` å’Œ `jar` æ–‡ä»¶ï¼Œä»¥åŠç›¸å…³ `C` æºç ï¼Œå¤‡ä»½åœ¨ [GitHub](https://github.com/chendongMarch/GifMaker/tree/master/backup/giflen) ä¸Šï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥ç›´æ¥ä¸‹è½½ä½¿ç”¨ã€‚ç»è¿‡æˆ‘çš„ç®€å•å°è¯•å‘ç°ï¼Œä½¿ç”¨ `so` åˆæˆçš„é€Ÿåº¦å’Œ `java` åˆæˆçš„é€Ÿåº¦å·®ä¸å¤šï¼Œéƒ½æ˜¯æ…¢çš„è¦æ­»...


## ä¼˜åŒ–åçš„ java åˆæˆ

åŸå§‹çš„åˆæˆæ–¹æ³•ï¼ŒçœŸçš„æ…¢...ç‰¹åˆ«æ…¢ï¼Œç®€ç›´ä¸èƒ½å¿ã€‚

åŸå§‹çš„åˆæˆæ–¹æ³•æ˜¯å°†æ¯ä¸€ä¸ª `Bitmap` ä½¿ç”¨ `LZWEncoder` è¿›è¡Œç¼–ç ï¼Œç”±äºæ˜¯ä¸€ä¸ªä¸²è¡Œçš„é€»è¾‘ï¼Œåé¢çš„å›¾ç‰‡éœ€è¦ç­‰å¾…å‰é¢çš„ç¼–ç å®Œæˆæ‰å¯ä»¥ç»§ç»­ä¸‹ä¸€å¼ ç¼–ç ï¼Œä¼˜åŒ–åçš„é€»è¾‘æ˜¯å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ¯å¼ å›¾ç‰‡ç‹¬ç«‹ç¼–ç ï¼Œæœ€ååœ¨æ‰€æœ‰å›¾ç‰‡ç¼–ç å®Œæˆä¹‹åè¾“å‡ºæµåˆå¹¶ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œå°±å®Œæˆäº† `gif` çš„åˆæˆã€‚

ç¼ºç‚¹ï¼šå¤§é‡çš„ `Bitmap` æŒæœ‰åœ¨å†…å­˜ä¸­å¹¶è¡Œç¼–ç ï¼Œå¯èƒ½ä¼š `OOM`ï¼Œä¸è¿‡æˆ‘æµ‹è¯• 20 å¼  450 * 600 çš„å›¾ç‰‡ï¼Œæš‚æ—¶æ²¡æœ‰å‡ºç°é—®é¢˜ã€‚åˆæˆçš„å›¾ç‰‡è¦æ±‚å®½é«˜åº”è¯¥æ˜¯ä¸€æ ·çš„ï¼Œå½“ç„¶ä½¿ç”¨å®½é«˜ä¸ä¸€è‡´çš„å›¾ç‰‡ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¼šä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€å¼ çš„å›¾ç‰‡çš„å®½é«˜ä½œä¸º `gif` çš„å®½é«˜ï¼Œå‡ºæ¥çš„å›¾ç‰‡å°±æœ‰äº›å°´å°¬ï¼Œå› æ­¤å›¾ç‰‡çš„è½¬æ¢å’Œå¤„ç†éœ€è¦åœ¨å¤–é¢å®Œæˆã€‚


## ç®€å•æ¼”ç¤º

```java
private void composeGif(List<Bitmap> bitmaps) {
    String absolutePath = new File(Environment.getExternalStorageDirectory()
            , System.currentTimeMillis() + ".gif").getAbsolutePath();
    new GifMaker(100, mExecutorService)
            .makeGifInThread(bitmaps, absolutePath, new GifMaker.OnGifMakerListener() {
                @Override
                public void onMakeGifSucceed(String outPath) {
                    if (!isFinishing()) {
                        GlideUtils.with(mActivity, outPath).into(mImageView);
                    }
                }
            });
}
```

çœ‹ä¸€ä¸‹è¾“å‡ºçš„ç»“æœï¼Œ20 å¼ å¤§çº¦ç»´æŒåœ¨ 12s å·¦å³

```java
I/GifMaker: å®Œæˆç¬¬10å¸§,è€—æ—¶:9.594 s - bitmap [600,450]
I/GifMaker: å®Œæˆç¬¬11å¸§,è€—æ—¶:9.774 s - bitmap [600,450]
I/GifMaker: å®Œæˆç¬¬18å¸§,è€—æ—¶:9.880 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬9å¸§,è€—æ—¶:10.41 s - bitmap [600,450]
I/GifMaker: å®Œæˆç¬¬17å¸§,è€—æ—¶:10.145 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬16å¸§,è€—æ—¶:10.331 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬6å¸§,è€—æ—¶:10.586 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬5å¸§,è€—æ—¶:10.557 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬8å¸§,è€—æ—¶:10.701 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬15å¸§,è€—æ—¶:10.715 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬4å¸§,è€—æ—¶:10.736 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬1å¸§,è€—æ—¶:10.835 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬19å¸§,è€—æ—¶:10.842 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬13å¸§,è€—æ—¶:10.940 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬0å¸§,è€—æ—¶:10.944 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬14å¸§,è€—æ—¶:10.967 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬3å¸§,è€—æ—¶:10.989 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬12å¸§,è€—æ—¶:10.994 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬2å¸§,è€—æ—¶:10.994 s - bitmap [450,600]
I/GifMaker: å®Œæˆç¬¬7å¸§,è€—æ—¶:11.148 s - bitmap [450,600]
I/GifMaker: åˆæˆå®Œæˆ,è€—æ—¶:11.167 s
```


