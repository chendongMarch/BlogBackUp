---
layout: post
title: Https è¯¦è§£ [ç½‘ç»œ]
category: Android
tags:
  - NetWork
abbrlink: 882ae1dd
keywords:
  - ç½‘ç»œ
  - Https
  - Http
  - TLS/SSL
  - åŠ å¯†
  - ç½‘ç»œé€šä¿¡
  - ç½‘ç»œå®‰å…¨
date: 2017-12-13 22:56:00
location: æ­å·å°šå¦†
photos: http://olx4t2q6z.bkt.clouddn.com/18-2-1/45157165.jpg
---

è¶…æ–‡æœ¬ä¼ è¾“å®‰å…¨åè®®ï¼ˆHTTPSï¼Œå¸¸ç§°ä¸ºHTTP over TLS/SSLï¼‰æ˜¯ä¸€ç§é€šè¿‡è®¡ç®—æœºç½‘ç»œè¿›è¡Œå®‰å…¨é€šä¿¡çš„ä¼ è¾“åè®®ã€‚HTTPSç»ç”±HTTPè¿›è¡Œé€šä¿¡ï¼Œä½†åˆ©ç”¨SSL/TLSæ¥åŠ å¯†æ•°æ®åŒ…ã€‚HTTPSå¼€å‘çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯æä¾›å¯¹ç½‘ç«™æœåŠ¡å™¨çš„èº«ä»½è®¤è¯ï¼Œä¿æŠ¤äº¤æ¢æ•°æ®çš„éšç§ä¸å®Œæ•´æ€§ã€‚


<!--more-->


æœ¬æ–‡ä¸»è¦ä»‹ç»  ï¼š

- Https å¦‚ä½•ä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨ 
- CA çš„å­˜åœ¨åŠå…¶å®‰å…¨æ€§
- è¯ä¹¦éªŒè¯æµç¨‹
- Https æ¡æ‰‹æµç¨‹
- Android ä¸‹è¿›è¡Œ Https è®¿é—®


## å‰è¨€

TCP (Transmission Control Protoco) ä¼ è¾“å±‚æ§åˆ¶åè®®

TLS (Transport Layer Security) ä¼ è¾“å±‚å®‰å…¨åå®š

SSL (Secure Socket Layer) å®‰å…¨å¥—æ¥å±‚

HTTP(Hypertext Transfer Protocol) åŸºäº TCP åè®®ï¼Œæ— è¿æ¥ï¼Œæ¯æ¬¡è¿æ¥åªå¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œç»“æŸåæ–­å¼€è¿æ¥ï¼›æ— çŠ¶æ€ï¼Œæ— æ³•ä¿æŒç”¨æˆ·çŠ¶æ€ï¼Œä½¿ç”¨ cookie å’Œ session è§£å†³ã€‚

HTTPS(HTTP over TLS/SSL) å®‰å…¨çš„ http åè®®ï¼ŒHTTP åè®®å’ŒTCP åè®®ä¹‹é—´å¢åŠ äº† TLS/SSL ä¿è¯æ•°æ®çš„å®‰å…¨ä¼ è¾“ã€‚

### å…³äº TLS/SSL

```

  1994å¹´ï¼ŒNetScapeå…¬å¸è®¾è®¡äº†SSLåè®®ï¼ˆSecure Sockets Layerï¼‰çš„1.0ç‰ˆï¼Œä½†æ˜¯æœªå‘å¸ƒã€‚

  1995å¹´ï¼ŒNetScapeå…¬å¸å‘å¸ƒSSL 2.0ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚

  1996å¹´ï¼ŒSSL 3.0ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚

  1999å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ISOCæ¥æ›¿NetScapeå…¬å¸ï¼Œå‘å¸ƒäº†SSLçš„å‡çº§ç‰ˆTLS 1.0ç‰ˆã€‚

  2006å¹´å’Œ2008å¹´ï¼ŒTLSè¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸ºTLS 1.1ç‰ˆå’ŒTLS 1.2ç‰ˆã€‚æœ€æ–°çš„å˜åŠ¨æ˜¯2011å¹´TLS 
1.2çš„ä¿®è®¢ç‰ˆã€‚

  TLS 1.0é€šå¸¸è¢«æ ‡ç¤ºä¸ºSSL 3.1ï¼ŒTLS 1.1ä¸ºSSL 3.2ï¼ŒTLS 1.2ä¸ºSSL 3.3ã€‚

  ç›®å‰ï¼Œåº”ç”¨æœ€å¹¿æ³›çš„æ˜¯TLS 1.0ï¼Œæ¥ä¸‹æ¥æ˜¯SSL 3.0ã€‚ä½†æ˜¯ï¼Œä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº†TLS 1.2çš„æ”¯æŒã€‚

```

## Https å®‰å…¨æ€§

HTTP åè®®çš„ä¸å®‰å…¨æ€§ä½“ç°åœ¨ 3 ä¸ªæ–¹é¢ï¼š

é£é™© | æè¿° | httpsè§£å†³æ–¹æ¡ˆ
:-- |:--|:--
çªƒå¬é£é™©|æ”»å‡»è€…å¯ä»¥è·çŸ¥æ¶ˆæ¯å†…å®¹|æ¶ˆæ¯åŠ å¯†
ç¯¡æ”¹é£é™©|æ”»å‡»è€…å¯ä»¥ç¯¡æ”¹æ¶ˆæ¯å†…å®¹|æ¶ˆæ¯æ‘˜è¦
å†’å……é£é™©|æ”»å‡»è€…å¯ä»¥å†’å……å…¶ä»–äººå‚ä¸é€šä¿¡|CA èº«ä»½è®¤è¯
CA ä¸å¯ä¿¡|ä¿¡ä»»çš„ CA ä¹±ç­¾å‘è¯ä¹¦|è¯ä¹¦é”  


### çªƒå¬/å—…æ¢

æŒ‡çš„æ˜¯è·¯ç”±ä¸Šçš„æ”»å‡»è€…ï¼Œå¯ä»¥å·çª¥åˆ°ä¼ è¾“çš„æ¶ˆæ¯å†…å®¹ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1. ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†é€šä¿¡å†…å®¹ï¼Œçªƒå¬è€…è·å–åˆ°æ¶ˆæ¯ä¹Ÿæ— æ³•è¯†åˆ«ï¼Œå­˜åœ¨é—®é¢˜ -> å¯†é’¥ä¼ é€’çš„å®‰å…¨æ€§ï¼Œåœ¨ç½‘ç»œä¸Šé¢çš„é€šä¿¡åŒæ–¹éƒ½æ˜¯é™Œç”Ÿäººï¼Œæ— æ³•è¯†åˆ«èº«ä»½ï¼Œå¯†é’¥è¦é€šè¿‡ç½‘ç»œä¼ è¾“æ—¶å¾ˆæœ‰å¯èƒ½è¢«çªƒå–ã€‚âŒ

2. ä½¿ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†é€šä¿¡å†…å®¹ï¼Œå‘å¸ƒçš„å…¬é’¥ç”¨æ¥åŠ å¯†ï¼Œç§é’¥ç”¨æ¥è§£å¯†ï¼Œå³ä½¿å…¬é’¥è¢«çªƒå–ï¼Œä¾ç„¶æ— æ³•è§£å¯†æ¶ˆæ¯å†…å®¹ã€‚å­˜åœ¨é—®é¢˜ -> é€Ÿåº¦æ…¢ï¼Œæ¶ˆè€—å¤§ï¼›å…¬é’¥è¢«å…¬å¼€ï¼Œå¦‚æœå›å‘ç§é’¥åŠ å¯†çš„ä¿¡æ¯ï¼Œä»»ä½•æŒæœ‰å…¬é’¥çš„äººéƒ½å¯ä»¥è§£å¯†ã€‚âŒ

3. æœ€ç»ˆï¼Œæ¶ˆæ¯å†…å®¹ä»æ—§ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•æ¥åŠ å¯†ï¼Œä½†æ˜¯å‰æœŸå¯¹ç§°åŠ å¯†çš„å¯†é’¥äº¤æ¢ä½¿ç”¨éå¯¹ç§°åŠ å¯†æ¥è¿›è¡Œï¼Œå®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡ç«¯å…¬é’¥åŠ å¯†å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œè¿™æ ·å°±åªæœ‰æ‹¥æœ‰ç§é’¥çš„æœåŠ¡ç«¯å¯ä»¥è·å–åˆ°åŠ å¯†å†…å®¹ï¼Œç”±äºå¯¹ç§°åŠ å¯†å¯†é’¥é•¿åº¦æœ‰é™ï¼ŒåŠ å¯†çš„æ—¶é—´å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚âœ…

ä»¥ä¸Šï¼Œå¯ä»¥é˜²æ­¢å—…æ¢çš„é—®é¢˜ï¼Œè·¯ç”±ä¸Šé¢çš„æ”»å‡»è€…å³ä½¿è·å–åˆ°æ¶ˆæ¯ä¹Ÿæ— æ³•è¯†åˆ«æ¶ˆæ¯çš„å†…å®¹ã€‚

### æ¶ˆæ¯ç¯¡æ”¹

æ¶ˆæ¯åŠ å¯†ä»¥åæ”»å‡»è€…æ— æ³•è·å–æ¶ˆæ¯å†…å®¹çš„å«ä¹‰ï¼Œä½†æ˜¯å¯ä»¥ç¯¡æ”¹æ¶ˆæ¯å†…å®¹ï¼Œç¯¡æ”¹ä¹‹åæ¥æ”¶æ–¹ä¹Ÿæ— æ³•æ„ŸçŸ¥ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- é‡‡ç”¨ [æ¶ˆæ¯æ‘˜è¦ï¼ˆè§æ–‡æœ«æ³¨è„šï¼‰](#æ¶ˆæ¯æ‘˜è¦) ç®—æ³•å¯ä»¥éªŒè¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œæˆ‘ä»¬å°†å‘é€çš„æ¶ˆæ¯è¿›è¡Œæ‘˜è¦ï¼Œè¿åŒæ¶ˆæ¯ä¸€èµ·å‘é€ç»™æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹æ‹¿åˆ°æ¶ˆæ¯ä¹‹åå¯¹æ¶ˆæ¯åšåŒæ ·çš„æ‘˜è¦å¤„ç†ï¼Œå¯¹æ¯”æ‘˜è¦ç»“æœï¼Œå³å¯çŸ¥é“æ¶ˆæ¯æœ‰æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚

ä»¥ä¸Šï¼Œå¯ä»¥è§£å†³æ¶ˆæ¯å®Œæ•´æ€§å’ŒçœŸå®æ€§çš„é—®é¢˜ã€‚

### ä¸­é—´äººæ”»å‡»

**ä¸­é—´äººæ”»å‡»**ï¼ˆMan-in-the-middle Attackï¼ŒMITMï¼‰æŒ‡çš„æ˜¯æ”»å‡»è€…åœ¨é“¾è·¯ä¸Šä¼ªè£…è‡ªå·±ï¼Œä¸é€šè®¯åŒæ–¹åˆ†åˆ«å»ºç«‹è”ç³»ï¼Œå¹¶äº¤æ¢å…¶æ‰€æ”¶åˆ°çš„æ•°æ®ï¼Œä½¿é€šè®¯çš„ä¸¤ç«¯è®¤ä¸ºä»–ä»¬æ­£åœ¨é€šè¿‡ä¸€ä¸ªç§å¯†çš„è¿æ¥ä¸å¯¹æ–¹ç›´æ¥å¯¹è¯ï¼Œä½†äº‹å®ä¸Šæ•´ä¸ªä¼šè¯éƒ½è¢«æ”»å‡»è€…å®Œå…¨æ§åˆ¶ã€‚

ä½œä¸º **A** å’Œ **B** é€šä¿¡è·¯ç”±ä¸Šçš„æ”»å‡»è€… **M**ï¼Œä½œä¸ºä¸­é—´äººä¼ªé€ è‡ªå·±çš„èº«ä»½ã€‚A å‘ B è¯·æ±‚ç”¨äºé€šä¿¡çš„ `PK_A`ï¼Œä½†æ˜¯è¢«ä¸­é—´äºº M æˆªè·ï¼Œä»–ä¼ªé€ ç”Ÿæˆäº†å‡çš„å…¬é’¥ `PK_M`ï¼Œå‘é€ç»™äº† Aï¼ŒåŒæ—¶å‘ B è¯·æ±‚å¹¶è·å–äº† B çš„å…¬å¼€å¯†é’¥ `PK_B`ï¼ŒåŸæ¥å®‰å…¨çš„é€šä¿¡è¿‡ç¨‹ A(ä½¿ç”¨ `PK_B` åŠ å¯†) -> å®‰å…¨ -> B(ä½¿ç”¨ `SK_B` è§£å¯†)ï¼Œç°åœ¨å˜æˆäº† A(ä½¿ç”¨ `PK_M` åŠ å¯†) -> M(ä½¿ç”¨ `SK_M` è§£å¯†è·å–æ˜æ–‡å†…å®¹ï¼Œå†ç”¨ `PK_B` åŠ å¯†ï¼Œå¯èƒ½ç¯¡æ”¹æ•°æ®) -> B(ä½¿ç”¨ `SK_B` è§£å¯†)ã€‚

å‡ºç°é—®é¢˜çš„åŸå› åœ¨äºï¼Œå¯†é’¥åœ¨äº¤æ¢çš„åˆæœŸæ˜¯ä¸å®‰å…¨çš„ï¼Œç½‘ç»œä¸Šçš„é€šä¿¡åŒæ–¹ï¼Œæ— æ³•ç¡®å®šå¯¹æ–¹çš„èº«ä»½ï¼Œå³æ— æ³•è·æ‚‰å½“å‰çš„å…¬é’¥æ˜¯ä¸æ˜¯è‡ªå·±æƒ³è¦çš„å…¬é’¥ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- å¼•å…¥ç¬¬ä¸‰æ–¹å…¬æ­£ä½œ[ä¿¡ç”¨èƒŒä¹¦](#ä¿¡ç”¨èƒŒä¹¦)ï¼Œç¬¬ä¸‰æ–¹å…¬æ­£å…·æœ‰æƒå¨æ€§ï¼Œä»–å’Œé€šä¿¡åŒæ–¹æ²¡æœ‰å…³ç³»ï¼Œæ¥æ”¶æ–¹æ— æ¡ä»¶ä¿¡ä»»å…¬è¯æœºæ„ï¼Œä¹Ÿå°±ä¼šä¿¡ä»»ä»–ç­¾åçš„ä¿¡æ¯ã€‚è¿™ç§æœºæ„è¢«ç§°ä¸º CAï¼ˆCertificate Authorityï¼‰æœºæ„ï¼Œå³æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ã€‚CA æœºæ„ä¸æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿå‚å•†åˆä½œï¼Œå°†å…¬é’¥å†…ç½®åœ¨æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸èµ°ç½‘ç»œä¼ è¾“äº†ï¼Œè¿™æ ·ä¸€å®šç¨‹åº¦ä¸Šä¿è¯äº†å…¬é’¥ä¸ä¼šè¢«çªƒå–ç¯¡æ”¹ã€‚

- æœåŠ¡ç«¯ B å°†è‡ªå·±çš„æ¶ˆæ¯ï¼ˆæ¶ˆæ¯å†…å®¹å¤§è‡´åŒ…æ‹¬ç”µå­ç­¾è¯æœºå…³çš„ä¿¡æ¯ã€å…¬é’¥ç”¨æˆ·ä¿¡æ¯ã€å…¬é’¥ã€æƒå¨æœºæ„çš„ç­¾å­—å’Œæœ‰æ•ˆæœŸç­‰ï¼‰è¿›è¡Œæ‘˜è¦ä¹‹åï¼Œå‘ç»™ CA æœºæ„ S ç­¾å‘è¯ä¹¦ï¼ŒS ä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯¹æ¶ˆæ¯æ‘˜è¦åŠ å¯†ï¼Œå½¢æˆè¯ä¹¦ï¼ŒB å°†è¯ä¹¦å’Œæ¶ˆæ¯å†…å®¹å‘é€ç»™ Aï¼ŒA æ”¶åˆ°åï¼Œå‘ç°æ˜¯ S çš„è¯ä¹¦ï¼ŒåŒæ—¶å¯¹ S æ˜¯ä¿¡ä»»çš„ï¼Œåˆ™ä¼šä½¿ç”¨ S çš„å…¬é’¥å¯¹è¯ä¹¦è¿›è¡Œè§£å¯†ï¼ˆè¿™é‡Œæ¶‰åŠè¯ä¹¦é“¾çš„éªŒè¯ï¼Œå…¶å®è¦æ›´åŠ å¤æ‚ï¼‰ï¼Œè·å–åˆ°æ¶ˆæ¯æ‘˜è¦ï¼ŒåŒæ—¶å¯¹æ”¶åˆ°çš„æ¶ˆæ¯è¿›è¡Œæ‘˜è¦ï¼Œå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´åˆ™è¯´æ˜å†…å®¹æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œæ˜¯å¯ä¿¡çš„ï¼Œå› ä¸ºç”ŸæˆåŠ å¯†æ•°æ®çš„ç§é’¥åªæœ‰ CA æœºæ„æ‰æœ‰ï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸ºéªŒè¯æ•°å­—ç­¾åã€‚

ä»¥ä¸Šï¼Œå¯ä»¥è§£å†³ä¸­é—´äººæ”»å‡»çš„æ–‡å›¾ï¼Œå¦å¤–æ¶‰åŠåˆ°éå¯¹ç§°åŠ å¯†çš„ä¸¤ç§åº”ç”¨åœºæ™¯ï¼Œè¯¦ç»†ä»‹ç»è§æ–‡æœ«[éå¯¹ç§°åŠ å¯†åº”ç”¨åœºæ™¯](#éå¯¹ç§°åŠ å¯†åº”ç”¨åœºæ™¯)ã€‚


### CA é”™è¯¯ç­¾å‘

å—ä¿¡ä»»çš„ CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰æœ‰å¥½å‡ ç™¾ä¸ªï¼Œä»–ä»¬æˆä¸ºæ•´ä¸ªç½‘ç«™èº«ä»½è®¤è¯è¿‡ç¨‹ä¸­ä¸€ä¸ªè¾ƒå¤§çš„æ”»å‡»é¢ã€‚å®é™…ä¸Šï¼Œç›®å‰ç”±äº CA å¤±è¯¯å¯¼è‡´é”™è¯¯ç­¾å‘è¯ä¹¦ï¼Œä»¥åŠä¸ªåˆ« CA å‡ºäºæŸäº›ç›®çš„ï¼ˆå¦‚ç›‘æ§åŠ å¯†æµé‡ï¼‰æ•…æ„å‘ç¬¬ä¸‰æ–¹éšæ„ç­¾å‘è¯ä¹¦è¿™ä¸¤ç§æƒ…å†µæ—¶æœ‰å‘ç”Ÿã€‚ç°æœ‰çš„è¯ä¹¦ä¿¡ä»»é“¾æœºåˆ¶æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œä»»ä½•ä¸€å®¶å—ä¿¡ä»»çš„ CA éƒ½å¯ä»¥ç­¾å‘ä»»æ„ç½‘ç«™çš„ç«™ç‚¹è¯ä¹¦ï¼Œè¿™äº›è¯ä¹¦åœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼Œéƒ½æ˜¯åˆæ³•çš„ï¼Œæ˜¯å¯ä»¥é€šè¿‡éªŒè¯çš„ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- è¯ä¹¦é”ï¼ˆCertificate Pinningï¼‰ï¼Œè¯ä¹¦é”æ˜¯ä¸ºäº†é˜²èŒƒç”±ã€Œä¼ªé€ æˆ–ä¸æ­£å½“æ‰‹æ®µè·å¾—ç½‘ç«™è¯ä¹¦ã€é€ æˆçš„ä¸­é—´äººæ”»å‡»ã€‚
 
- è¯ä¹¦é”ç±»ä¼¼äº `HPKP` æŠ€æœ¯ï¼ˆä¸‹é¢æœ‰ç®€å•ä»‹ç»ï¼‰ï¼Œç»™äºˆæˆ‘ä»¬ä¸»åŠ¨é€‰æ‹©ä¿¡ä»» CA çš„æƒåˆ©ã€‚å®ƒçš„å·¥ä½œåŸç†å°±æ˜¯ä½¿ç”¨é¢„å…ˆè®¾ç½®çš„è¯ä¹¦æŒ‡çº¹å’ŒæœåŠ¡å™¨ä¼ è¿‡æ¥çš„è¯ä¹¦é“¾ä¸­çš„è¯ä¹¦æŒ‡çº¹è¿›è¡ŒåŒ¹é…ï¼Œåªè¦æœ‰ä»»ä½•ä¸€å¯¹æŒ‡çº¹åŒ¹é…æˆåŠŸï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€æ¬¡åˆæ³•çš„è¿æ¥ï¼Œå¦åˆ™ç¦æ­¢æœ¬æ¬¡é“¾æ¥ã€‚

- ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨è¯ä¹¦é”ä¹‹åï¼Œä¸æ˜¯æ‰€æœ‰è¢«ç³»ç»Ÿä¿¡ä»»çš„ CA éƒ½å¯ä»¥é€šè¿‡éªŒè¯ï¼Œåªæœ‰æˆ‘ä¿å­˜äº†æŒ‡çº¹çš„ä¸€äº› CA ç­¾å‘çš„è¯ä¹¦æ‰å¯ä»¥ï¼Œæ¯”å¦‚æœ‰ 100 ä¸ª CA æœºæ„ï¼Œä½†æˆ‘å°±ä¿¡ä»»å…¶ä¸­ä¸€ä¸ªï¼Œæˆ‘å¯ä»¥ä¿è¯è¿™ä¸ª CA ä¸ä¼šä¹±ç­¾å‘è¯ä¹¦ï¼Œé‚£æˆ‘å°±åªä¿å­˜è¿™ä¸ª CA çš„æŒ‡çº¹ï¼Œå³ä½¿æ”»å‡»è€…ä»å…¶ä»–çš„ 99 ä¸ª CA ç­¾å‘è¯ä¹¦ï¼Œå¯¹æˆ‘è¿›è¡Œæ”»å‡»ï¼Œä¹Ÿæ— æ³•å®Œæˆè¿æ¥ã€‚

- è¯ä¹¦é”å®šå¢åŠ äº†å®‰å…¨æ€§ï¼Œä½†é™åˆ¶äº†ä½ çš„æœåŠ¡å™¨å›¢é˜Ÿå‡çº§TLSè¯ä¹¦çš„èƒ½åŠ›ã€‚

ä»¥ä¸Šï¼Œå¯ä»¥è§£å†³ CA æœºæ„ç­¾å‘è¯ä¹¦æƒå¨æ€§ä¸è¶³çš„é—®é¢˜ï¼Œç›¸å…³è§£å†³æ–¹æ¡ˆè¯¦è§æ–‡æœ«[ç­¾å‘è¯ä¹¦æƒå¨æ€§é—®é¢˜](#ç­¾å‘è¯ä¹¦æƒå¨æ€§é—®é¢˜)

ğŸ”¥  **ç»¼ä¸Šï¼Œå¯¹ç§°åŠ å¯†é€šä¿¡ + éå¯¹ç§°åŠ å¯†äº¤æ¢å¯†é’¥ + CA è®¤è¯èº«ä»½ + è¯ä¹¦é”é”å®šè¯ä¹¦æŒ‡çº¹ å…±åŒä¿è¯äº† https çš„å®‰å…¨æ€§ã€‚**

## CA å®‰å…¨æ€§

ä½œä¸ºå…¨ç½‘ https è¿æ¥çš„æƒå¨å…¬æ­£ï¼ŒCA çš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚

### å®‰å…¨ä¿å­˜ CAåŠè¯ä¹¦éªŒè¯

ä»æ ¹ CA å¼€å§‹åˆ°ç›´æ¥ç»™å®¢æˆ·å‘æ”¾è¯ä¹¦çš„å„å±‚æ¬¡ CAï¼Œéƒ½æœ‰å…¶è‡ªèº«çš„å¯†é’¥å¯¹ã€‚CA ä¸­å¿ƒçš„å¯†é’¥å¯¹ä¸€èˆ¬ç”±ç¡¬ä»¶åŠ å¯†æœåŠ¡å™¨åœ¨æœºå™¨å†…ç›´æ¥äº§ç”Ÿï¼Œå¹¶å­˜å‚¨äºåŠ å¯†ç¡¬ä»¶å†…ï¼Œæˆ–ä»¥ä¸€å®šçš„åŠ å¯†å½¢å¼å­˜æ”¾äºå¯†é’¥æ•°æ®åº“å†…ã€‚åŠ å¯†å¤‡ä»½äº IC å¡æˆ–å…¶ä»–å­˜å‚¨ä»‹è´¨ä¸­ï¼Œå¹¶ä»¥é«˜ç­‰çº§çš„ç‰©ç†å®‰å…¨æªæ–½ä¿æŠ¤èµ·æ¥ã€‚å¯†é’¥çš„é”€æ¯è¦ä»¥å®‰å…¨çš„å¯†é’¥å†²å†™æ ‡å‡†ï¼Œå½»åº•æ¸…é™¤åŸæœ‰çš„å¯†é’¥ç—•è¿¹ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ ¹ CA å¯†é’¥çš„å®‰å…¨æ€§è‡³å…³é‡è¦ï¼Œå®ƒçš„æ³„éœ²æ„å‘³ç€æ•´ä¸ªå…¬é’¥ä¿¡ä»»ä½“ç³»çš„å´©æºƒï¼Œæ‰€ä»¥ CA çš„å¯†é’¥ä¿æŠ¤å¿…é¡»æŒ‰ç…§æœ€é«˜å®‰å…¨çº§çš„ä¿æŠ¤æ–¹å¼æ¥è¿›è¡Œè®¾ç½®å’Œç®¡ç†ã€‚CAçš„ç§é’¥æ˜¯è‡ªå·±é ä¸Šè¿°æ–¹æ³•ä¿ç®¡çš„ï¼Œä¸å¯¹å¤–å…¬å¼€ã€‚

CA çš„å…¬é’¥æ˜¯å‚å•†è·Ÿæµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿåˆä½œï¼ŒæŠŠå…¬é’¥é»˜è®¤è£…åˆ°æµè§ˆå™¨æˆ–è€…æ“ä½œç³»ç»Ÿç¯å¢ƒé‡Œã€‚æ¯”å¦‚ firefox å°±è‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªå¯ä¿¡ä»»çš„ CA åˆ—è¡¨ï¼Œè€Œ chrome å’Œ IE ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„ CA åˆ—è¡¨ã€‚

### è¯ä¹¦é“¾

ç°åœ¨å¤§çš„ CA éƒ½ä¼šæœ‰è¯ä¹¦é“¾ï¼Œè¯ä¹¦é“¾çš„å¥½å¤„ä¸€æ˜¯å®‰å…¨ï¼Œä¿æŒæ ¹ CA çš„ç§é’¥ç¦»çº¿ä½¿ç”¨ã€‚ç¬¬äºŒä¸ªå¥½å¤„æ˜¯æ–¹ä¾¿éƒ¨ç½²å’Œæ’¤é”€ï¼Œå³å¦‚æœè¯ä¹¦å‡ºç°é—®é¢˜ï¼Œåªéœ€è¦æ’¤é”€ç›¸åº”çº§åˆ«çš„è¯ä¹¦ï¼Œæ ¹è¯ä¹¦ä¾ç„¶å®‰å…¨ã€‚
æ ¹ CA è¯ä¹¦éƒ½æ˜¯è‡ªç­¾åï¼Œå³ç”¨è‡ªå·±çš„å…¬é’¥å’Œç§é’¥å®Œæˆäº†ç­¾åçš„åˆ¶ä½œå’ŒéªŒè¯ã€‚è€Œè¯ä¹¦é“¾ä¸Šçš„è¯ä¹¦ç­¾åéƒ½æ˜¯ä½¿ç”¨ä¸Šä¸€çº§è¯ä¹¦çš„å¯†é’¥å¯¹å®Œæˆç­¾åå’ŒéªŒè¯çš„ã€‚


### è¯ä¹¦éªŒè¯

è¯ä¹¦æ˜¯å¦æ˜¯ä¿¡ä»»çš„æœ‰æ•ˆè¯ä¹¦

1. æ˜¯å¦ä¿¡ä»» ï¼šæ¥æ”¶æ–¹å†…ç½®äº†ä¿¡ä»»æ ¹è¯ä¹¦çš„å…¬é’¥ï¼Œéœ€è¦è¯ä¹¦æ˜¯ä¸æ˜¯è¿™äº›ä¿¡ä»»æ ¹è¯ä¹¦ç­¾å‘çš„æˆ–è€…ä¿¡ä»»æ ¹è¯ä¹¦çš„äºŒçº§è¯ä¹¦æœºæ„é¢å‘çš„ã€‚

2. æ˜¯å¦æœ‰æ•ˆï¼šè¯ä¹¦æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ã€‚

3. æ˜¯å¦åˆæ³•ï¼šå¯¹æ–¹æ˜¯ä¸æ˜¯ä¸Šè¿°è¯ä¹¦çš„åˆæ³•æŒæœ‰è€…ï¼Œè¯æ˜å¯¹æ–¹æ˜¯å¦æŒæœ‰è¯ä¹¦çš„å¯¹åº”ç§é’¥ã€‚éªŒè¯æ–¹æ³•ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¯¹æ–¹ç­¾ä¸ªåï¼Œæˆ‘ç”¨è¯ä¹¦éªŒè¯ç­¾åï¼›å¦å¤–ä¸€ç§æ˜¯ç”¨è¯ä¹¦åšä¸ªä¿¡å°ï¼Œçœ‹å¯¹æ–¹æ˜¯å¦èƒ½è§£å¼€ã€‚

4. æ˜¯å¦åŠé”€ï¼šéªŒè¯æ˜¯å¦åŠé”€å¯ä»¥é‡‡ç”¨é»‘åå•æ–¹å¼æˆ–è€…OCSPæ–¹å¼ã€‚é»‘åå•å°±æ˜¯å®šæœŸä»CAä¸‹è½½ä¸€ä¸ªåå•åˆ—è¡¨ï¼Œé‡Œé¢æœ‰åŠé”€çš„è¯ä¹¦åºåˆ—å·ï¼Œè‡ªå·±åœ¨æœ¬åœ°æ¯”å¯¹ä¸€ä¸‹å°±è¡Œã€‚ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ã€‚ç¼ºç‚¹æ˜¯ä¸å®æ—¶ã€‚OCSPæ˜¯å®æ—¶è¿æ¥CAå»éªŒè¯ï¼Œä¼˜ç‚¹æ˜¯å®æ—¶ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä¸é«˜ã€‚
 
### è‡ªç­¾åè¯ä¹¦å¦‚ä½•éªŒè¯

è‡ªç­¾åè¯ä¹¦æ˜¯è‡ªå·±ç»™è‡ªå·±ç­¾å‘çš„è¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯è¯´è‡ªå·±åšè‡ªå·±çš„ CA æœºæ„ï¼Œä¸ºè‡ªå·±æ‹…ä¿ï¼Œå› æ­¤æ— æ³•å†…ç½®åœ¨ç³»ç»Ÿå½“ä¸­ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸ä¼šåœ¨å®¢æˆ·å†…ç½®ä¸€ä¸ªè¯ä¹¦æ–‡ä»¶ï¼Œè‡ªå·±è¿›è¡Œæ ¡éªŒã€‚

ç®€å•æ¥è¯´ï¼Œæ¡æ‰‹æµç¨‹éœ€è¦ä¸¤å¯¹å¯†é’¥å¯¹ï¼š

1. ä¸€å¯¹ CA çš„å¯†é’¥å¯¹ `JKS_A`ï¼Œç”± CA æœºæ„ç»´æŠ¤ï¼Œé€šå¸¸ä»–çš„å…¬é’¥å†…ç½®åœ¨ os ä¸­ï¼Œç”¨æ¥ç­¾åæœåŠ¡ç«¯ä¿¡æ¯æ‘˜è¦ï¼Œä¿è¯æœåŠ¡ç«¯å…¬é’¥çš„çœŸå®æ€§ï¼Œé¿å…ä¸­é—´äººæ”»å‡»ã€‚
2. ä¸€å¯¹æœåŠ¡å™¨çš„å¯†é’¥å¯¹ `JKS_B`ï¼Œä»–æ˜¯æ¡æ‰‹è¿‡ç¨‹ä¸­éšæœºç”Ÿæˆçš„ï¼Œç„¶åç”¨ã€Œå®ƒçš„å…¬é’¥åŠå…¶ä»–å†…å®¹ã€çš„æ‘˜è¦å»å‘ CA å®æ—¶ç­¾å‘è¯ä¹¦ï¼Œç”¨æ¥è¿›è¡Œå¯¹ç§°å¯†é’¥çš„åŠ å¯†ä¼ è¾“ã€‚

è‡ªç­¾åè¯ä¹¦å°±æ˜¯ä¸èµ° CA æœºæ„ï¼Œè€Œæ˜¯è‡ªå·±ç”Ÿæˆä¸€å¯¹å¯†é’¥å¯¹ `JKS_C`ï¼Œä»–çš„ä½œç”¨å°±å¥½æ¯” CA çš„å¯†é’¥å¯¹ `JKS_A`ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä¿è¯å…¬é’¥çš„çœŸå®æ€§ï¼Œæ¡æ‰‹è¿‡ç¨‹å’ŒåŸæ¥ä¸€æ ·ï¼Œåªæ˜¯æˆ‘ä»¬ä¸éœ€è¦å» CA ç­¾å‘è¯ä¹¦äº†ï¼Œç”¨è‡ªå·±çš„ `JKS_C` ç­¾å‘å°±å¯ä»¥äº†ï¼›åŒæ ·å› ä¸º `JKS_C` æ˜¯æˆ‘ä»¬è‡ªå·±çš„å¯†é’¥å¯¹ï¼Œå…¬é’¥æ²¡æœ‰è¢«å†…ç½®åœ¨ os ä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦æˆ‘ä»¬è‡ªå·±æŠŠ `cert` æ–‡ä»¶ï¼ˆ`JKS_C` çš„å…¬é’¥ï¼‰æ”¾åˆ°æœ¬åœ°ï¼Œè‡ªå·±å®ŒæˆåŸæœ¬ç”± os å®Œæˆçš„ CA æ ¡éªŒä»»åŠ¡ã€‚


### åŒå‘éªŒè¯

åŒå‘éªŒè¯æŒ‡çš„æ˜¯ï¼Œä¸å…‰å®¢æˆ·ç«¯è¦éªŒè¯æ¥è‡ªæœåŠ¡å™¨çš„è¿æ¥æ˜¯ä¸æ˜¯å¯é ï¼ŒæœåŠ¡å™¨ä¹Ÿè¦éªŒè¯å®¢æˆ·ç«¯ã€‚

æœåŠ¡ç«¯ä¹Ÿä¼šå†…ç½®ä¸€å¥—å—ä¿¡ä»»çš„ CA è¯ä¹¦åˆ—è¡¨ï¼Œç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„çœŸå®æ€§ã€‚éªŒè¯è¿‡ç¨‹å’Œå®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯ç±»ä¼¼ã€‚

 

## Https æ¡æ‰‹

å•å‘éªŒè¯æ¡æ‰‹è¿‡ç¨‹ï¼š

- 1ã€Client Hello  â¡ï¸

> å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¡æ‰‹ä¿¡æ¯ï¼Œå‘ŠçŸ¥è‡ªå·±æ”¯æŒçš„åŠ å¯†ç®—æ³•ã€æ‘˜è¦ç®—æ³•ã€å®‰å…¨å±‚åè®®ç‰ˆæœ¬ã€éšæœºæ•° `Random-Secret-C`ã€‚

- 2ã€Server Hello  â¬…ï¸

> æœåŠ¡ç«¯éšæœºç”Ÿæˆæœ¬æ¬¡æ¡æ‰‹éœ€è¦çš„éå¯¹ç§°åŠ å¯†çš„å¯†é’¥å¯¹ï¼ˆç§é’¥+å…¬é’¥ï¼‰ï¼Œå°†æ¥ç”¨æ¥ä¼ è¾“å¯¹ç§°åŠ å¯†å¯†é’¥ã€‚

> æœåŠ¡ç«¯ç”Ÿæˆæ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«éšæœºæ•° `Random-Secret-S`ï¼Œç¡®å®šçš„ä¸€ç»„åŠ å¯†ç®—æ³•å’Œæ‘˜è¦ç®—æ³•ï¼ŒæœåŠ¡ç«¯å…¬é’¥ï¼ŒåŸŸåä¿¡æ¯ç­‰ã€‚

> æœåŠ¡ç«¯å¯¹ä¿¡æ¯å†…å®¹æ‘˜è¦ï¼Œä½¿ç”¨æ‘˜è¦çš„ä¿¡æ¯å‘ CA æœºæ„ç”³è¯·çš„ç­¾åè¯ä¹¦ã€‚

> æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯å’Œç”³è¯·çš„è¯ä¹¦ã€‚

> **å¦‚æœéœ€è¦åŒå‘éªŒè¯çš„è¯ï¼Œè¯·æ±‚å®¢æˆ·ç«¯è¯ä¹¦ã€‚**

- 3ã€éªŒè¯æœåŠ¡ç«¯è¯ä¹¦ï¼Œæå–æœåŠ¡ç«¯å…¬é’¥  â¡ï¸

> å®¢æˆ·ç«¯ä»ä¿¡ä»»è¯ä¹¦åˆ—è¡¨ä¸­å‘ç°æ˜¯å—ä¿¡ä»»çš„è¯ä¹¦ï¼Œä¼šé¦–å…ˆéªŒè¯è¯ä¹¦æ˜¯å¦è¢«ä¿¡ä»»ã€æœ‰æ•ˆæ€§ã€åˆæ³•æ€§ç­‰ä¿¡æ¯ï¼ŒéªŒè¯è¿‡ç¨‹å‚ç…§ä¸Šé¢çš„ **è¯ä¹¦éªŒè¯**ã€‚

> éªŒè¯é€šè¿‡ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ `CA` æœºæ„çš„å…¬é’¥å¯¹è¯ä¹¦è§£å¯†ï¼Œæ‹¿åˆ°æ¶ˆæ¯çš„æ‘˜è¦ï¼Œå¯¹çœŸæ­£çš„æ¶ˆæ¯å†…å®¹è¿›è¡Œæ‘˜è¦ï¼Œå¯¹æ¯”ç¡®å®šæ¶ˆæ¯æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œåˆ™å–å‡ºæœåŠ¡ç«¯å…¬é’¥ã€‚

> **å¦‚æœéœ€è¦åŒå‘éªŒè¯çš„è¯ï¼Œå‘æœåŠ¡ç«¯å‘é€è‡ªå·±çš„è¯ä¹¦ã€‚**

> å®¢æˆ·ç«¯ç”Ÿæˆéšæœºæ•°å­— `Pre-Master-Secret`ï¼Œå°†å…¶è¿›è¡Œæ‘˜è¦å¤„ç†ï¼Œä½¿ç”¨æœåŠ¡ç«¯å…¬é’¥å¯¹æ¶ˆæ¯å’Œæ‘˜è¦ç»“æœåŠ å¯†ï¼Œå‘é€ç»™æœåŠ¡å™¨ï¼Œå¹¶å‘é€ä¸€ä¸ªç¼–ç æ”¹å˜é€šçŸ¥ï¼Œè¯´æ˜ä»¥åå°†ä¼šå¼€å§‹åŠ å¯†é€šä¿¡ã€‚

- 4ã€ç”Ÿæˆå¯¹ç§°åŠ å¯†å¯†é’¥  â¬…ï¸

> **å¦‚æœéœ€è¦åŒå‘éªŒè¯çš„è¯ï¼Œé¦–å…ˆéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒéªŒè¯è¿‡ç¨‹ç±»ä¼¼å®¢æˆ·ç«¯éªŒè¯ï¼ŒéªŒè¯å¤±è´¥åˆ™æ–­å¼€è¿æ¥**

> æœåŠ¡å™¨ä½¿ç”¨ç§é’¥å¯¹æ”¶åˆ°çš„ä¿¡æ¯è§£å¯†ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œæ‘˜è¦å¯¹æ¯”æ— è¯¯ï¼Œåˆ™è¯´æ˜å¯¹ç§°åŠ å¯†çš„å¯†é’¥æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œç„¶åä½¿ç”¨ `Random-Secret-C`,`Random-Secret-S`,`Pre-Master-Secret` ç”Ÿæˆæœ€ç»ˆå°†è¦è¿›è¡Œå¯¹ç§°åŠ å¯†é€šä¿¡çš„å¯†é’¥ `Master-Secret`ã€‚

> æœåŠ¡å™¨ä½¿ç”¨ `Master-Secret` åŠ å¯†ä¸€æ®µæ¡æ‰‹ä¿¡æ¯åŠå…¶æ‘˜è¦ï¼Œå‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¹¶å‘é€ä¸€ä¸ªç¼–ç æ”¹å˜é€šçŸ¥ï¼Œè¯´æ˜ä»¥åå°†ä¼šå¼€å§‹åŠ å¯†é€šä¿¡ã€‚

- 5ã€å®¢æˆ·ç«¯éªŒè¯åŠ å¯†ç»“æœï¼Œæ¡æ‰‹ç»“æŸ ğŸ‘Œ

> å®¢æˆ·ç«¯ä½¿ç”¨ `Random-Secret-C`,`Random-Secret-S`,`Pre-Master-Secret` ç”ŸæˆåŒæ ·çš„å¯¹ç§°åŠ å¯†å¯†é’¥ `Master-Secret`ï¼Œä½¿ç”¨å¯†é’¥è§£å¯†ï¼Œå¹¶éªŒè¯ä¿¡æ¯æ‘˜è¦ï¼Œæ²¡æœ‰é—®é¢˜åˆ™æ¡æ‰‹ç»“æŸã€‚

> åé¢çš„é€šä¿¡å°†ä¼šä½¿ç”¨æ–°ç”Ÿæˆçš„å¯¹ç§°åŠ å¯†å¯†é’¥åŠ å¯†è¿›è¡Œã€‚

å›¾è§£ï¼š

![https](http://olx4t2q6z.bkt.clouddn.com/17-12-19/94724225.jpg)

 
## Q&A

Qï¼šä¸ºä»€ä¹ˆè¦æœ‰ 3 ä¸ªéšæœºæ•°ï¼Ÿ

> ä¸ç®¡æ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ï¼Œéƒ½éœ€è¦éšæœºæ•°ï¼Œè¿™æ ·ç”Ÿæˆçš„å¯†é’¥æ‰ä¸ä¼šæ¯æ¬¡éƒ½ä¸€æ ·ã€‚ç”±äºSSLåè®®ä¸­è¯ä¹¦æ˜¯é™æ€çš„ï¼Œå› æ­¤ååˆ†æœ‰å¿…è¦å¼•å…¥ä¸€ç§éšæœºå› ç´ æ¥ä¿è¯åå•†å‡ºæ¥çš„å¯†é’¥çš„éšæœºæ€§ã€‚å¯¹äºRSAå¯†é’¥äº¤æ¢ç®—æ³•æ¥è¯´ï¼ŒPre-Master-Secret æœ¬èº«å°±æ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œå†åŠ ä¸Šhelloæ¶ˆæ¯ä¸­çš„éšæœºï¼Œä¸‰ä¸ªéšæœºæ•°é€šè¿‡ä¸€ä¸ªå¯†é’¥å¯¼å‡ºå™¨æœ€ç»ˆå¯¼å‡ºä¸€ä¸ªå¯¹ç§°å¯†é’¥ã€‚

> Pre-Master çš„å­˜åœ¨åœ¨äº SSL åè®®ä¸ä¿¡ä»»æ¯ä¸ªä¸»æœºéƒ½èƒ½äº§ç”Ÿå®Œå…¨éšæœºçš„éšæœºæ•°ï¼Œå¦‚æœéšæœºæ•°ä¸éšæœºï¼Œé‚£ä¹ˆ Pre-Master-Secret å°±æœ‰å¯èƒ½è¢«çŒœå‡ºæ¥ï¼Œé‚£ä¹ˆä»…é€‚ç”¨ Pre-Master-Secret ä½œä¸ºå¯†é’¥å°±ä¸åˆé€‚äº†ï¼Œå› æ­¤å¿…é¡»å¼•å…¥æ–°çš„éšæœºå› ç´ ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŠ ä¸Š Pre-Master-Secret ä¸‰ä¸ªéšæœºæ•°ä¸€åŒç”Ÿæˆçš„å¯†é’¥å°±ä¸å®¹æ˜“è¢«çŒœå‡ºäº†ï¼Œä¸€ä¸ªä¼ªéšæœºå¯èƒ½å®Œå…¨ä¸éšæœºï¼Œå¯æ˜¯æ˜¯ä¸‰ä¸ªä¼ªéšæœºå°±ååˆ†æ¥è¿‘éšæœºäº†ï¼Œæ¯å¢åŠ ä¸€ä¸ªè‡ªç”±åº¦ï¼Œéšæœºæ€§å¢åŠ çš„å¯ä¸æ˜¯ä¸€ã€‚"


Qï¼šæ”¾åœ¨ Android å®¢æˆ·ç«¯çš„ cert æ–‡ä»¶æ˜¯å•¥ï¼Ÿ

> æ˜¯è‡ªç­¾åè¯ä¹¦çš„å…¬é’¥ï¼Œè‡ªç­¾åè¯ä¹¦å°±æ˜¯è‡ªå·±åšè‡ªå·±çš„ CA æœºæ„ï¼ŒæœåŠ¡ç«¯ä¼šè‡ªå·±ç»´æŠ¤ä¸€ä¸ªå¯†é’¥å¯¹ JKSï¼Œä»–å°±ç›¸å½“äº CA çš„ç­¾å‘è¯ä¹¦çš„å¯†é’¥å¯¹ï¼Œåœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­æœåŠ¡å™¨ä¸éœ€è¦èµ° CA ç”³è¯·ç­¾åè¯ä¹¦äº†ï¼Œè‡ªå·±ç­¾å‘å°±å¯ä»¥ï¼ŒåŸæœ¬ CA çš„å…¬é’¥è¢«å†…ç½®åœ¨ os ä¸­ï¼ŒCA çš„éªŒè¯ä¸éœ€è¦æˆ‘ä»¬æ¥å…³æ³¨ï¼Œä½†æ˜¯ç°åœ¨æ˜¯è‡ªç­¾åçš„ï¼Œè‡ªå·±åšè‡ªå·±çš„ CAï¼Œæ‰€ä»¥ JKS çš„å…¬é’¥æˆ‘ä»¬è¦å†…ç½®åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œè‡ªå·±å®ŒæˆéªŒè¯è¿‡ç¨‹ï¼Œæ›¿ä»£åŸæ¥ os çš„éªŒè¯ã€‚

## è¯ä¹¦å·¥å…·-keytool


æå–è¯ä¹¦å†…å®¹ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²

```
keytool -printcert -rfc -file [srca.cer]
```

ç”Ÿæˆå¯†é’¥å¯¹

```
keytool -genkey -alias [march_server] -keyalg RSA -keystore [march_server.jks] -validity 3600 -storepass [123456]
```

è¯»å–å¯†é’¥å¯¹ä¿¡æ¯

```
keytool -list -v -keystore [srca.jks] -storepass [123456] 
```

æå–å…¬é’¥ï¼Œç­¾å‘ `cert` æ–‡ä»¶

```
keytool -export -alias march_server -file march_server.cer -keystore march_server.jks -storepass 123456
```

å°†å®¢æˆ·ç«¯å…¬é’¥å¯¼å…¥å®¢æˆ·ç«¯å¯†é’¥å¯¹ä¸­ï¼Œä¸»è¦æ˜¯æœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨ `cert` è¯ä¹¦ï¼Œéœ€è¦å¯¼å…¥åˆ° `jks` æ–‡ä»¶ä¸­

```
keytool -import -alias [march_client] -file [march_client.cer] -keystore [march_client_for_server.jks]
```


## æ­å»º https æœåŠ¡

è¿™éƒ¨åˆ†å†…å®¹å‚è€ƒäº† [CSDN-hongyang-Android Https å®Œå…¨è§£æ](http://blog.csdn.net/lmj623565791/article/details/48129405)ï¼Œè¿™é‡Œåšä¸€ä¸ªæ±‡æ€»å’Œæ•´ç†ã€‚

å€ŸåŠ© `tomcat` æ­å»ºç®€å•çš„ `https` æœåŠ¡ï¼Œä¸»è¦æ˜¯ç”¨æ¥æµ‹è¯•ï¼Œä¹‹å‰ä½¿ç”¨ `12306` çš„è¯ä¹¦æµ‹è¯•ï¼Œä½†æ˜¯å‰æ®µæ—¶é—´ `12306` è¯ä¹¦æ¢æ‰äº†ï¼Œç°åœ¨å·²ç»æ˜¯æ­£å¼è¯ä¹¦äº†ï¼Œæ‰€ä»¥ä¸å¾—ä»¥éœ€è¦è‡ªå·±æ­å»ºä¸€ä¸ªç®€å•çš„æœåŠ¡æ¥åšè®¿é—®æµ‹è¯•ã€‚

- æ­å»ºå•å‘éªŒè¯çš„ https æœåŠ¡

é¦–å…ˆæˆ‘ä»¬å‡†å¤‡å¥½å¯†é’¥å’Œè¯ä¹¦ï¼Œä½¿ç”¨ `keytool` å·¥å…·ç”ŸæˆæœåŠ¡ç«¯ `march_server.jks` å¯†é’¥å¯¹ï¼Œç„¶åæå–æœåŠ¡ç«¯å…¬é’¥ `march_server.cert`ã€‚

é…ç½®æœåŠ¡ï¼Œä¸»è¦æ˜¯é…ç½® `tomcat/conf/server.xml` æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªå¦‚ä¸‹çš„ `Connector`ã€‚

```
<!-- 
  https æµ‹è¯•æœåŠ¡
  clientAuth å’Œ truststoreFile é…ç½®æœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯
  keystoreFile å’Œ keystorePass é…ç½®å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨
  -->
  <Connector
    
    clientAuth="false"
    
    keystoreFile="/Users/march/Documents/march_server.jks" 
    keystorePass="123456" 

    disableUploadTimeout="true" 
    enableLookups="true" 
    SSLEnabled="true" 
    acceptCount="100"  
    maxSpareThreads="75" 
    maxThreads="200" 
    minSpareThreads="5" 
    protocol="org.apache.coyote.http11.Http11NioProtocol" 
    scheme="https" 
    secure="true" 
    port="8443" 
    sslProtocol="TLS"/>
```

- æ­å»ºåŒå‘éªŒè¯çš„ https æœåŠ¡

å†ç”Ÿæˆå®¢æˆ·ç«¯å¯†é’¥å¯¹ `march_client.jks`ï¼Œç„¶åç­¾å‘å®¢æˆ·ç«¯å…¬é’¥ `march_client.cert`ï¼Œä¸ºäº†èƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨ï¼Œå°† `march_client.cert` å¯¼å…¥åˆ°æ–°çš„å¯†é’¥å¯¹ `march_client_for_server.jks`ã€‚ä½¿ç”¨çš„å‘½ä»¤éƒ½å¯ä»¥åœ¨ä¸Šä¸€èŠ‚æ‰¾åˆ°ï¼Œç”Ÿæˆè¿™å‡ ä¸ªå¯†é’¥ï¼Œæ˜¯ä¸ºäº†æ­å»ºåé¢çš„æœåŠ¡ä½œå‡†å¤‡ã€‚
 
æ›´æ”¹ `conf/server.xml` é…ç½®

```
<!-- 
  https æµ‹è¯•æœåŠ¡
  clientAuth å’Œ truststoreFile é…ç½®æœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯
  keystoreFile å’Œ keystorePass é…ç½®å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨
   -->
  <Connector 
    
    clientAuth="true"
    truststoreFile="/Users/march/Documents/march_client_for_server.jks" 
    
    keystoreFile="/Users/march/Documents/march_server.jks" 
    keystorePass="123456" 

    disableUploadTimeout="true" 
    enableLookups="true" 
    SSLEnabled="true" 
    acceptCount="100"  
    maxSpareThreads="75" 
    maxThreads="200" 
    minSpareThreads="5" 
    protocol="org.apache.coyote.http11.Http11NioProtocol" 
    scheme="https" 
    secure="true" 
    port="8443" 
    sslProtocol="TLS"/>
```

æ­¤æ—¶æµè§ˆå™¨å·²ç»ä¸èƒ½è®¿é—®


## Android è¿›è¡Œ Https è®¿é—®

å¦‚æœä½ çš„è¯ä¹¦æ˜¯è´­ä¹°çš„ CA ç­¾å‘çš„è¯ä¹¦ï¼Œæ˜¯å¯ä»¥ç›´æ¥è¿›è¡Œ https è®¿é—®çš„ï¼Œä¸éœ€è¦åšä»€ä¹ˆç‰¹æ®Šå¤„ç†ï¼Œä¸‹é¢ä¸»è¦ä»‹ç»ä½¿ç”¨è‡ªç­¾åè¯ä¹¦çš„æƒ…å†µã€‚

å¯ç”¨åŒå‘éªŒè¯æ—¶ï¼ŒAndroid å®¢æˆ·ç«¯ä¹Ÿä¸èƒ½ç›´æ¥ä½¿ç”¨ `march_client.jks` éœ€è¦è½¬ä¸º `bks` æ–‡ä»¶ï¼Œä½¿ç”¨ä¸‹é¢çš„å·¥å…·ã€‚[jks è½¬ bks å·¥å…·](https://sourceforge.net/projects/portecle/files/latest/download?source=files)


æ³¨ï¼šè¿™éƒ¨åˆ†ä¸æ˜¯è¯´å¦‚ä½•å‘è¯·æ±‚ï¼Œåªæ˜¯è®¨è®ºæ€ä¹ˆé…ç½®è¯ä¹¦å’Œå¯†é’¥å¯¹å»å‘èµ· Https è®¿é—®ã€‚

åœ¨ Android ä¸­è¿›è¡Œ Https è®¿é—®ï¼Œä¸»è¦ç‰µæ‰¯åˆ°ä»¥ä¸‹å‡ ä¸ªå…³é”®ç±»

1. TrustManagerFactoryï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥å¯¼å…¥è‡ªç­¾åè¯ä¹¦ï¼Œç”¨æ¥éªŒè¯æ¥è‡ªæœåŠ¡å™¨çš„è¿æ¥ã€‚
2. KeyManagerFactoryï¼Œå½“å¼€å¯åŒå‘éªŒè¯æ—¶ï¼Œç”¨æ¥å¯¼å…¥å®¢æˆ·ç«¯çš„å¯†é’¥å¯¹ã€‚
3. SSLContextï¼ŒSSL ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ä¸Šé¢çš„ä¸¤ä¸ªç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œå°±æ˜¯ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒã€‚

ğŸ˜  éƒ½è®©å¼€ï¼Œæˆ‘è¦è´´ä»£ç äº†ï¼


### SSLContext

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ç”Ÿæˆ SSLContext

```java
/**
 * åˆ›å»º SSLContext 
 * @param keyManagerFactory ç”¨äºåŒå‘éªŒè¯ï¼Œä¸éœ€è¦å¯ä»¥ç›´æ¥ä¸ºç©º
 * @param trustManagerFactory ç”¨äºå¯¼å…¥è¯ä¹¦
 * @return SSLContext
 */
private SSLContext getSSLContext(@Nullable KeyManagerFactory keyManagerFactory,
        TrustManagerFactory trustManagerFactory)
        throws NoSuchAlgorithmException, KeyManagementException {
    if (trustManagerFactory == null)
        return null;
    SSLContext sslContext = SSLContext.getInstance("TLS");
    KeyManager[] keyManagers = null;
    if (keyManagerFactory != null) {
        keyManagers = keyManagerFactory.getKeyManagers();
    }
    sslContext.init(keyManagers, trustManagerFactory.getTrustManagers(), new SecureRandom());
    return sslContext;
}
```


### TrustManagerFactory

å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”Ÿæˆ TrustManagerFactory

```java
/**
 * å¯¼å…¥å®¢æˆ·ç«¯è¯ä¹¦ï¼Œç”Ÿæˆ TrustManagerFactory
 * @param serverCertInputStreams è¯ä¹¦çš„è¾“å…¥æµ
 * @return TrustManagerFactory
 */
private TrustManagerFactory getTrustManagerFactory(InputStream... serverCertInputStreams)
        throws KeyStoreException, CertificateException, NoSuchAlgorithmException, IOException {
    if (serverCertInputStreams == null || serverCertInputStreams.length == 0) {
        return null;
    }
    CertificateFactory certificateFactory = CertificateFactory.getInstance("X.509");
    // ä¸ºè¯ä¹¦è®¾ç½®ä¸€ä¸ªkeyStoreï¼Œå¹¶å°†è¯ä¹¦æ”¾å…¥ keyStore ä¸­
    KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());
    keyStore.load(null, null);
    int index = 0;
    for (InputStream inputStream : serverCertInputStreams) {
        String alias = Integer.toString(index++);
        Certificate certificate = certificateFactory.generateCertificate(inputStream);
        keyStore.setCertificateEntry(alias, certificate);
    }
    // åˆ›å»º TrustManagerFactory
    TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());
    trustManagerFactory.init(keyStore);
    TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();
    if (trustManagers.length != 1 || !(trustManagers[0] instanceof X509TrustManager)) {
        throw new IllegalStateException("Unexpected default trust managers:"
                + Arrays.toString(trustManagers));
    }
    return trustManagerFactory;
}
```

### KeyManagerFactory

åŒå‘éªŒè¯æ—¶ï¼Œé…ç½®å®¢æˆ·ç«¯å¯†é’¥å¯¹ï¼Œç”Ÿæˆ KeyManagerFactory

```java
/**
 * åŒå‘éªŒè¯æ—¶ï¼Œé…ç½®å®¢æˆ·ç«¯å¯†é’¥å¯¹ï¼Œç”Ÿæˆ KeyManagerFactory
 *
 * @param clientCertInputStream å¯†é’¥å¯¹è¾“å…¥æµ
 * @param passWd                å¯†é’¥å¯¹å¯†ç 
 * @return KeyManagerFactory
 */
private KeyManagerFactory getKeyManagerFactory(InputStream clientCertInputStream, String passWd)
        throws KeyStoreException, CertificateException, NoSuchAlgorithmException, IOException, UnrecoverableKeyException {
    if (clientCertInputStream == null || passWd == null) {
        return null;
    }
    //æœ¬åœ°è¯ä¹¦ åˆå§‹åŒ–keystore
    KeyStore clientKeyStore = KeyStore.getInstance(KeyStore.getDefaultType());
    clientKeyStore.load(clientCertInputStream, passWd.toCharArray());
    KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());
    keyManagerFactory.init(clientKeyStore, passWd.toCharArray());
    return keyManagerFactory;
}
```

### Init Connection

è¿™æ ·æˆ‘ä»¬å°±æ‹¿åˆ°äº†å·²ç»ç”Ÿæˆå¥½çš„ SSLContextï¼Œæˆ‘ä»¬éœ€è¦çš„ KeyManagerFactoryï¼ŒTrustManagerFactory éƒ½å·²ç»åŠ åˆ° SSLContext é‡Œé¢äº†ã€‚

å¦‚æœæ˜¯ç”¨ `HttpsURLConnection`

```java
connection.setSSLSocketFactory(sslContext.getSocketFactory());
```
å¦‚æœæ˜¯ç”¨ `OkHttp`

```java
// è¿™ä¸ªæ–¹æ³•å·²ç»è¿‡æ—¶äº†
okHttpClientBuilder.sslSocketFactory(sslContext.getSocketFactory());

// æ–°çš„æ–¹æ³•éœ€è¦ä¸€ä¸ª X509TrustManagerï¼Œé‚£æˆ‘ä»¬å°±ä» TrustManagerFactory å–å‡ºæ¥ç»™ä»–
TrustManagerFactory trustManagerFactory = getTrustManagerFactory(serverCertInputStreams);
KeyManagerFactory keyManagerFactory = getKeyManagerFactory(clientCertInputStream, passWd);
if (trustManagerFactory != null) {
    X509TrustManager x509TrustManager = (X509TrustManager) trustManagerFactory.getTrustManagers()[0];
    SSLContext sslContext = getSSLContext(keyManagerFactory, trustManagerFactory);
    if (x509TrustManager != null && sslContext != null) {
        okHttpClientBuilder.sslSocketFactory(sslContext.getSocketFactory(), x509TrustManager);
    }
}
```

### HostnameVerifier

å¦å¤– `HostnameVerifier` ä¹Ÿæ˜¯å¿…è¦çš„ï¼Œè¿™ä¸ª `HttpsURLConnection` å’Œ `OkHttp` æ²¡å•¥å·®åˆ«

```java
connection.setHostnameVerifier(new HostnameVerifier() {
    @Override
    public boolean verify(String hostname, SSLSession session) {
        return true;
    }
});

okHttpClientBuilder.hostnameVerifier(new HostnameVerifier() {
    @Override
    public boolean verify(String hostname, SSLSession session) {
        return true;
    }
});
```


## å·¨äººçš„è‚©è†€

[CSDN å¦‚ä½•ç†è§£HTTPåè®®çš„ â€œæ— è¿æ¥ï¼Œæ— çŠ¶æ€â€ ç‰¹ç‚¹ï¼Ÿ](http://blog.csdn.net/tennysonsky/article/details/44562435)
	
[çŸ¥ä¹ ä¸€ä¸ªæ•…äº‹è®©ä½ å½»åº•ç†è§£ Https](https://zhuanlan.zhihu.com/p/31880655)

[ç®€ä¹¦ HTTPS æ˜¯å¦‚ä½•ä¿è¯å®‰å…¨çš„ï¼Ÿ](http://www.jianshu.com/p/b894a7e1c779)

[ä¸ªäººåšå®¢-é¥¿äº†ä¹ˆAndroid-èŠèŠ Android HTTPS çš„ä½¿ç”¨å§¿åŠ¿](http://dieyidezui.com/talk-about-android-https/)

[ä¸ªäººåšå®¢-ç»†è¯´ CA å’Œè¯ä¹¦](http://www.barretlee.com/blog/2016/04/24/detail-about-ca-and-certs/)

[ä¸ªäººåšå®¢-httpsè¯¦è§£](http://luojinping.com/2016/04/17/https%E8%AF%A6%E8%A7%A3/) æ¦‚è¦ä»‹ç»

[CSDN-hongyang-Android Https å®Œå…¨è§£æ](http://blog.csdn.net/lmj623565791/article/details/48129405)

[é˜®ä¸€å³°-SSL/TLSåè®®è¿è¡Œæœºåˆ¶çš„æ¦‚è¿°](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)

	


## æ³¨è„š

<span id="æ¶ˆæ¯æ‘˜è¦"/>
**æ¶ˆæ¯æ‘˜è¦ï¼ˆMessage Digestï¼‰**

æŒ‡çš„æ˜¯å°†é•¿åº¦ä¸å›ºå®šçš„å‚æ•°ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè¿è¡Œç‰¹å®š hash å‡½æ•°ï¼Œç”Ÿæˆå›ºå®šé•¿åº¦çš„è¾“å‡ºï¼Œè¿™ä¸ªè¾“å‡ºå°±æ˜¯æ¶ˆæ¯çš„æ‘˜è¦ï¼Œå¸¸ç”¨ç®—æ³•æœ‰ `MD5` å’Œ `SHA1`ï¼Œæ‘˜è¦ç®—æ³•æ˜¯å•å‘ä¸å¯é€†çš„ï¼Œå³æ— æ³•ä»æ‘˜è¦é‡æ–°åå‘å‡ºåŸæ¶ˆæ¯çš„å†…å®¹ã€‚


<span id="ä¿¡ç”¨èƒŒä¹¦"/>
**ä¿¡ç”¨èƒŒä¹¦**

ç¥¨æ®çš„æ”¶æ¬¾äººæˆ–æŒæœ‰äººåœ¨è½¬è®©ç¥¨æ®æ—¶ï¼Œåœ¨ç¥¨æ®èƒŒé¢ç­¾åæˆ–ä¹¦å†™æ–‡å¥çš„æ‰‹ç»­ã€‚èƒŒä¹¦çš„äººå°±ä¼šå¯¹è¿™å¼ æ”¯ç¥¨è´ŸæŸç§ç¨‹åº¦ã€ç±»ä¼¼æ‹…ä¿çš„å¿è¿˜è´£ä»»ã€‚


<span id="éå¯¹ç§°åŠ å¯†åº”ç”¨åœºæ™¯"/>
**éå¯¹ç§°åŠ å¯†çš„ä¸¤ç§åº”ç”¨åœºæ™¯**

1. æŸç”¨æˆ·ä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯¹æ•°æ®åŠ å¯†ï¼Œä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨å…¬é’¥å¯¹æ•°æ®è¿›è¡Œè§£å¯†ï¼Œå› ä¸ºç§é’¥åªæœ‰è¯¥ç”¨æˆ·æŒæœ‰ï¼Œåˆ™è¯´æ˜è¯¥æ•°æ®ä¸€å®šå‡ºè‡ªäºè¯¥ç”¨æˆ·ã€‚å…¬ä¼—å¯ä»¥ç”¨è¿™ä¸€æ–¹æ³•éªŒè¯å†…å®¹æ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦è¢«ç¯¡æ”¹ï¼Œæ¥å—è€…å¯ä»¥è®¤å®šè¯¥å†…å®¹å‡ºè‡ªè¯¥ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·ä¹Ÿæ— æ³•æŠµèµ–ï¼Œè¿™è¢«ç§°ä½œæ•°å­—ç­¾åã€‚
2. æŸç”¨æˆ·ä½¿ç”¨å…¬å¼€çš„å…¬é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œé‚£ä¹ˆå¯ä»¥ä¿è¯åªæœ‰å‘å¸ƒå…¬é’¥çš„ä¸€æ–¹å¯ä»¥å¯¹æ•°æ®è¿›è¡Œè§£å¯†ï¼Œåˆ«äººæ— æ³•è·å–æ•°æ®çš„å†…å®¹ï¼Œä¿è¯æ•°æ®ä¼ é€’çš„å®‰å…¨ã€‚


<span id="ç­¾å‘è¯ä¹¦æƒå¨æ€§é—®é¢˜"/>

**åº”å¯¹ CA ç­¾å‘è¯ä¹¦æƒå¨æ€§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ**

1. Google æ¨åŠ¨çš„ Certificate Transparency æŠ€æœ¯ï¼Œå®ƒæ—¨åœ¨é€šè¿‡å¼€æ”¾çš„å®¡è®¡å’Œç›‘æ§ç³»ç»Ÿï¼Œæé«˜ HTTPS ç½‘ç«™è¯ä¹¦å®‰å…¨æ€§ã€‚CT æŠ€æœ¯èƒ½æ”¹å–„è¿™ç§æƒ…å†µï¼Œä½† CT è¿˜æ²¡æœ‰æ™®åŠï¼Œç°é˜¶æ®µæµè§ˆå™¨ä¸èƒ½è´¸ç„¶é˜»æ–­æ²¡æœ‰æä¾› SCT ä¿¡æ¯çš„ HTTPS ç½‘ç«™ã€‚[CT ä»‹ç»](https://imququ.com/post/certificate-transparency.html)

2. HTTP Public Key Pinning æŠ€æœ¯ [HPKP ä»‹ç»](https://imququ.com/post/http-public-key-pinning.html)

