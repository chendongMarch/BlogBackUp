---
layout: post
title: 首页加载优化
date: 2016-07-28
category: 资源
tags: BBPP
keywords: 
description: 首页加载优化
---


## 多线程下载对比

1. Activity进行数据下载耗时263526(4.6min)


2. Service进行数据下载耗时275278(4.7min)


3. Service线程池数据下载耗时(3条线线程)


```java
0号线程耗时99582
1号线程耗时102942
2号线程耗时106173（1.7min）
```


## 多线程总结

- 现在的网络请求框架okhttp内部有4个线程，支持最多64个并发，单机最大5个并发请求,现在的操作是一次请求完再发起下一次请求。


```java
maxRequests = 64: 最大并发请求数为64
maxRequestsPerHost = 5: 每个主机最大请求数为5
```




## 解决方案

### 服务器

1. 单页数据增加，现在是50


2. 压缩传输（GZIP）单次传输更多数据


### 客户端

1. 多线程下载，每个线程负责自己的页数(跟林杰讨论说现在一个客户端最多一条连接？)


2. 下载和存储异步,不存储的话,时间会缩短很多（时间对比5min vs 12.5min）,现在是请求一次数据就存一次,全部请求完存完才显示UI


3. 数据库操作耗时，但更换数据库成本太高,现在用的库不知道是不是最快的（应该还好,调研过，不是最快的也是前二）
但是插入数据耗费了很多时间,这个主要是对比我新建的工程（不进行存储操作）耗时5min左右和宝宝拍拍工程12.5min左右
除了数据库插入耗时也有可能是别的UI绘制和请求占用了网速和CPU.

4. 现在是单条数据插入，使用批量插入更快，有待优化。（这个之前就了解了，没来得及改）

5. 现在 '首次数据拉取' 和 '增量更新' 的逻辑分的不是很清楚，首次拉取时做了多余的操作，分开之后首次拉取就可以批量插入了，参考4


### UI

1. 不要让用户感觉到一直阻碍在首页，如果服务器可以发有序数据，拉取2页照片，获得最后时间戳，拉取时间戳之前的视频，展示这些数据供用户浏览（用户应该是比较关心新数据的），禁掉所有不能做的操作。将真正的下载任务发布到后台进行，数据完全到达时，再刷新首页，就不用一直卡在那里。如果是这样的话，请求和存储异步不异步差别就不大了，都是要请求完存完再操作。


## 流程图
### 基本流程
![基本流程](http://7xtjec.com1.z0.glb.clouddn.com/%E9%A6%96%E9%A1%B5%E7%85%A7%E7%89%87%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B.png)
### 分离首次数据拉取和数据更新
![分离首次数据拉取和数据更新](http://7xtjec.com1.z0.glb.clouddn.com/%E9%A6%96%E9%A1%B5%E7%85%A7%E7%89%87%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%20%281%29.png)
### 请求和存储异步
![请求和存储异步](http://7xtjec.com1.z0.glb.clouddn.com/%E9%A6%96%E9%A1%B5%E7%85%A7%E7%89%87%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%20%282%29.png)




